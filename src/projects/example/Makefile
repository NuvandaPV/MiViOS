#
# Makefile
#
# Created by Jean-Pierre Höhmann on 18-09-13.
#
# Copyright 2018 Jean-Pierre Höhmann (@NuvandaPV) <jean-pierre@höhmann.info>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#   http://www.apache.org/license/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

#
# Make instructions for the hello world example application.
#

DEFAULT_HOST?=i686-elf
HOST?=$(DEFAULT_HOST)
HOSTARCH!=../../../target-triplet-to-arch.sh $(HOST)

AR?=$(HOST)-ar
AS?=$(HOST)-as
CC?=$(HOST)-cc

CFLAGS_DEFAULT=-O2 -g
CFLAGS_EXTRA=-Wall -Wextra
CPPFLAGS_DEFAULT=
CPPFLAGS_EXTRA=-Iinclude
LDFLAGS_DEFAULT=
LDFLAGS_EXTRA=
LIBS_DEFAULT=
LIBS_EXTRA=

USER_CFLAGS_DEFAULT=-O0
USER_CFLAGS_EXTRA=
USER_CPPFLAGS_DEFAULT=
USER_CPPFLAGS_EXTRA=-D__is_user
USER_LDFLAGS_DEFAULT=
USER_LDFLAGS_EXTRA=
USER_LIBS_DEFAULT=
USER_LIBS_EXTRA=

EXAMPLE_CFLAGS_DEFAULT=
EXAMPLE_CFLAGS_EXTRA=
EXAMPLE_CPPFLAGS_DEFAULT=
EXAMPLE_CPPFLAGS_EXTRA=-D__is_example
EXAMPLE_LDFLAGS_DEFAULT=
EXAMPLE_LDFLAGS_EXTRA=
EXAMPLE_LIBS_DEFAULT=
EXAMPLE_LIBS_EXTRA=

DESTDIR?=
PREFIX?=/usr/local
EXEC_PREFIX?=$(PREFIX)
BOOTDIR?=$(EXEC_PREFIX)/boot
INCLUDEDIR?=$(PREFIX)/include

CFLAGS_DEFAULT:=$(CFLAGS_DEFAULT)
CPPFLAGS_DEFAULT:=$(CPPFLAGS_DEFAULT)
LDFLAGS_DEFAULT:=$(LDFLAGS_DEFAULT)
LIBS_DEFAULT:=$(LIBS_DEFAULT)

CFLAGS_EXTRA:=$(CFLAGS_EXTRA)
CPPFLAGS_EXTRA:=$(CPPFLAGS_EXTRA)
LDFLAGS_EXTRA:=$(LDFLAGS_EXTRA)
LIBS_EXTRA:=$(LIBS_EXTRA)

CFLAGS?=$(CFLAGS_DEFAULT)
CPPFLAGS?=$(CPPFLAGS_DEFAULT)
LDFLAGS?=$(LDFLAGS_DEFAULT)
LIBS?=$(LIBS_DEFAULT)

CFLAGS:=$(CFLAGS)
CPPFLAGS:=$(CPPFLAGS)
LDFLAGS:=$(LDFLAGS)
LIBS:=$(LIBS)

USER_CFLAGS_DEFAULT:=$(CFLAGS) $(USER_CFLAGS_DEFAULT)
USER_CPPFLAGS_DEFAULT:=$(CPPFLAGS) $(USER_CPPFLAGS_DEFAULT)
USER_LDFLAGS_DEFAULT:=$(LDFLAGS) $(USER_LDFLAGS_DEFAULT)
USER_LIBS_DEFAULT:=$(LIBS) $(USER_LIBS_DEFAULT)

USER_CFLAGS_EXTRA:=$(CFLAGS_EXTRA) $(USER_CFLAGS_EXTRA)
USER_CPPFLAGS_EXTRA:=$(CPPFLAGS_EXTRA) $(USER_CPPFLAGS_EXTRA)
USER_LDFLAGS_EXTRA:=$(LDFLAGS_EXTRA) $(USER_LDFLAGS_EXTRA)
USER_LIBS_EXTRA:=$(LIBS_EXTRA) $(USER_LIBS_EXTRA)

USER_CFLAGS?=$(USER_CFLAGS_DEFAULT)
USER_CPPFLAGS?=$(USER_CPPFLAGS_DEFAULT)
USER_LDFLAGS?=$(USER_LDFLAGS_DEFAULT)
USER_LIBS?=$(USER_LIBS_DEFAULT)

USER_CFLAGS:=$(USER_CFLAGS)
USER_CPPFLAGS:=$(USER_CPPFLAGS)
USER_LDFLAGS:=$(USER_LDFLAGS)
USER_LIBS:=$(USER_LIBS)

EXAMPLE_CFLAGS_DEFAULT:=$(USER_CFLAGS) $(EXAMPLE_CFLAGS_DEFAULT)
EXAMPLE_CPPFLAGS_DEFAULT:=$(USER_CPPFLAGS) $(EXAMPLE_CPPFLAGS_DEFAULT)
EXAMPLE_LDFLAGS_DEFAULT:=$(USER_LDFLAGS) $(EXAMPLE_LDFLAGS_DEFAULT)
EXAMPLE_LIBS_DEFAULT:=$(USER_LIBS) $(EXAMPLE_LIBS_DEFAULT)

EXAMPLE_CFLAGS_EXTRA:=$(USER_CFLAGS_EXTRA) $(EXAMPLE_CFLAGS_EXTRA)
EXAMPLE_CPPFLAGS_EXTRA:=$(USER_CPPFLAGS_EXTRA) $(EXAMPLE_CPPFLAGS_EXTRA)
EXAMPLE_LDFLAGS_EXTRA:=$(USER_LDFLAGS_EXTRA) $(EXAMPLE_LDFLAGS_EXTRA)
EXAMPLE_LIBS_EXTRA:=$(USER_LIBS_EXTRA) $(EXAMPLE_LIBS_EXTRA)

EXAMPLE_CFLAGS?=$(EXAMPLE_CFLAGS_DEFAULT)
EXAMPLE_CPPFLAGS?=$(EXAMPLE_CPPFLAGS_DEFAULT)
EXAMPLE_LDFLAGS?=$(EXAMPLE_LDFLAGS_DEFAULT)
EXAMPLE_LIBS?=$(EXAMPLE_LIBS_DEFAULT)

EXAMPLE_CFLAGS:=$(EXAMPLE_CFLAGS)
EXAMPLE_CPPFLAGS:=$(EXAMPLE_CPPFLAGS)
EXAMPLE_LDFLAGS:=$(EXAMPLE_LDFLAGS)
EXAMPLE_LIBS:=$(EXAMPLE_LIBS)

CFLAGS:=$(CFLAGS) $(CFLAGS_EXTRA)
CPPFLAGS:=$(CPPFLAGS) $(CPPFLAGS_EXTRA)
LDFLAGS:=$(LDFLAGS) $(LDFLAGS_EXTRA)
LIBS:=$(LIBS) $(LIBS_EXTRA)

USER_CFLAGS:=$(USER_CFLAGS) $(USER_CFLAGS_EXTRA)
USER_CPPFLAGS:=$(USER_CPPFLAGS) $(USER_CPPFLAGS_EXTRA)
USER_LDFLAGS:=$(USER_LDFLAGS) $(USER_LDFLAGS_EXTRA)
USER_LIBS:=$(USER_LIBS) $(USER_LIBS_EXTRA)

EXAMPLE_CFLAGS:=$(EXAMPLE_CFLAGS) $(EXAMPLE_CFLAGS_EXTRA)
EXAMPLE_CPPFLAGS:=$(EXAMPLE_CPPFLAGS) $(EXAMPLE_CPPFLAGS_EXTRA)
EXAMPLE_LDFLAGS:=$(EXAMPLE_LDFLAGS) $(EXAMPLE_LDFLAGS_EXTRA)
EXAMPLE_LIBS:=$(EXAMPLE_LIBS) $(EXAMPLE_LIBS_EXTRA)

OBJS=\
example/example.o \

BINARIES=\
example.elf \

.PHONY: all clean install
.SUFFIXES: .o .c

all: $(BINARIES)

example.elf: $(OBJS)
	$(CC) -o $@ $(EXAMPLE_CFLAGS) $(EXAMPLE_LDFLAGS) $(OBJS) $(EXAMPLE_LIBS)

.c.o:
	$(CC) -MD -c $< -o $@ -std=gnu11 $(EXAMPLE_CFLAGS) $(EXAMPLE_CPPFLAGS)

clean:
	rm -f $(BINARIES) $(OBJS) $(OBJS:.o=.d)

install: $(BINARIES)
	mkdir -p $(DESTDIR)/$(BOOTDIR)
	cp -R --preserve=timestamps $(BINARIES) $(DESTDIR)/$(BOOTDIR)

-include $(OBJS:.o=.d)
